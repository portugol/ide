<!DOCTYPE html>
<html>
	<head>
    	<meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>PORTUGOL - IDE</title>
        <meta name="description" content="Blueprint: Slide and Push Menus" />
        <meta name="keywords" content="sliding menu, pushing menu, navigation, responsive, menu, css, jquery" />
        <meta name="author" content="Codrops" />
        <link rel="shortcut icon" href="../favicon.ico">
        
        <link rel="stylesheet" type="text/css" href="css/default.css" />
        <link rel="stylesheet" type="text/css" href="css/component.css" />

        <script src="libs/modernizr.custom.js"></script>
    	<script src="libs/jquery.min.js"></script>
    	<script src="libs/raphael-min.js"></script>
        <script src="libs/classie.js"></script>
        <script src="http://130.185.82.181:8080/socket.io/socket.io.js"></script>

        <script src="js/connection.js"></script>
    	<script src="js/DragFunctions.js"></script>
    	<script src="js/node.js"></script>
    	<script src="js/graph.js"></script>

		<style>
			body{
                background-color: #F1F1F1;
            }
            #toolbar{  
                background-color: #C0C0C0;
                height:80px;
                border: 10px solid #aaa; 
                border-radius: 25px;   
            }  
            #work{
                width: 88%;
                height: 100%;
                margin-right: 160px;
                float: right;
            }
            #sidebar{
                background-color: #C0C0C0;
                width:50px;
                height:675px;
                border: 5px solid #aaa; 
                border-radius: 25px;
                float:right;
                }

			#canvas{
				border: 0px solid black;
				width: 100%;
				height: 100%;
				float: left;

			}
		</style>

		<script>
    		$(document).on('ready', function() {

    			var Drag = new DragFunctions();
                var socket = io.connect('http://130.185.82.181:8080');
                var running=false;
                var stepping=false;
                var selectTool=true;

                enableBtnExecute(true);
                enableBtnStart(true);
                enableBtnNext(false);
                enableBtnStop(false);

                socket.on('validated', function (){
                    clearMemory(); //limpar memória
                    clearConsole(); //limpar consola
                    Drag.reverseAll(); //restaurar cores originais
                    Drag.undragAll();  //não permitir arrastar elementos
                    if(stepping){
                        enableBtnStart(false);
                        enableBtnExecute(false);
                        enableBtnStart(false);
                        enableBtnStop(true);
                        enableBtnNext(true);
                    }
                    else{
                        enableBtnExecute(false);
                        enableBtnStart(false);
                        enableBtnStop(true);
                        enableBtnNext(false);
                    }
                    writeConsoleInfo("--- Execution started ---");
                });

                socket.on('highlight', function (payload){          
                    Drag.stepHighlight(payload.actual, payload.previous); 
                    enableBtnNext();
                    
                    var vars=JSON.parse(payload.memory);
                    clearMemory();
                    fillMemory(vars);
                });

                socket.on('restore', function (uuid){
                    Drag.reverseHighlight(uuid); 
                });

                socket.on('requestInput', function(){
                    var input = prompt('Introduza o valor que deseja atribuir:','');
                    socket.emit('inputFromIDE',input);
                });

                socket.on('errors', function(errors){
                    clearConsole();
                    Drag.reverseAll();
                    for(var i=0; i<errors.length; i++){
                        console.log(errors[i].message);
                        writeConsoleError(errors[i].message);
                        if(errors[i].uuid!==undefined){
                            console.log(errors[i].uuid);
                            Drag.errorHighlight(errors[i].uuid); 
                        }
                    } 
                });

                socket.on('errorAbort', function (error){
                    console.log("ERROR ABORT");
                    console.log(error.message);
                    writeConsoleError(error.message);
                    Drag.reverseHighlight(error.previous);
                    Drag.errorHighlight(error.uuid);
                    running=false;
                    stepping=false;
                    enableBtnStart(true);
                    enableBtnExecute(true);
                    enableBtnStop(false);
                    enableBtnNext(false);
                    Drag.dragAll();
                });

                socket.on('finished', function (payload){
                    running=false;
                    stepping=false;
                    enableBtnStart(true);
                    enableBtnExecute(true);
                    enableBtnStop(false);
                    enableBtnNext(false);
                    Drag.stepHighlight(payload.actual, payload.previous);
                    fillMemory(payload.memory);
                    writeConsoleInfo("--- Execution finished ---");
                    console.log("terminou o fluxograma");
                    Drag.dragAll();
                });

                socket.on('executionAborted',function (uuid){
                    if(stepping){
                        Drag.reverseHighlight(uuid);
                    }
                    running=false;
                    stepping=false;
                    enableBtnStart(true);
                    enableBtnExecute(true);
                    enableBtnStop(false);
                    enableBtnNext(false);
                    clearMemory();
                    writeConsoleInfo("--- Execution aborted ---");
                    Drag.dragAll();
                });

                socket.on('consoleUpdate', function (data){
                  writeConsoleMessage(data);
                });
                $('#btnValidar').on('click', function (){
                  var json = Drag.graph.extract();
                  socket.emit('flowchart', json);
                });
                
                $('#btnExecutar').on('click', function (){
                  var json = Drag.graph.extract();
                  console.log(json);    
                  socket.emit('execute', json);
                });

                $('#btnStart').on('click', function(){
                    if($(this).is(":disabled")==false){
                        var json = Drag.graph.extract();
                        socket.emit('start', json);
                        stepping=true;
                    }
                });

                $('#btnStop').on('click', function(){
                    if($(this).is(":disabled")==false){
                        socket.emit('stopExecution');
                    }
                });

                $('#btnNext').on('click', function(){
                    if($(this).is(":disabled")==false){
                        enableBtnNext(false);
                        if(stepping){
                            socket.emit('next');
                            console.log("emitiu o NEXT");
                        }
                    }
                });

                $('#btnAbrir').on('click', function (){
                    dragndrop.graphclean();
                    var nomegrafo = prompt('Inserir o grafo que deseja abrir:','');

                    $.ajax({
                        async:false,
                        cache: false,
                        type: 'GET',
                        url: 'http://130.185.82.181/couchget/' + nomegrafo,
                        data: {},
                        dataType: 'json',
                        success: function(json) {
                            if(json.result !== undefined || json.result == 'nok') {
                                alert(json.message);
                            } else {
                                dragndrop.jsontographic(JSON.stringify(json.grafo));
                            }
                        },
                        error:function (xhr, ajaxOptions, thrownError){
                            if(xhr.readyState == 0 || xhr.status == 0) {
                                return;
                            } else {
                                alert(xhr.status);
                                alert(thrownError);
                            }
                        }
                    });
                   
                });

                $('#btnApagar').on('click', function() {
                    dragndrop.graphclean();
                    
                });

                $('#btnGuardar').on('click', function (){
                    var nomegrafo = prompt('Nome para o Grafo:','');
                    json = Drag.graph.extract();
                    json = JSON.parse(json);
                    $.ajax({
                        async:false,
                        cache: false,
                        type: 'POST',
                        url: 'http://130.185.82.181/couchset',
                        data: {
                            _id: nomegrafo,
                            grafo: json
                        },
                        dataType: 'json',
                        success: function(json) {
                            console.log(json);
                            if(json.result == 'ok') {
                                alert("Guardado com sucesso!");
                            } else {
                                alert(json.message);
                            }
                        },
                        error:function (xhr, ajaxOptions, thrownError){
                            if(xhr.readyState == 0 || xhr.status == 0) {
                                return;
                            } else {
                                alert(xhr.status);
                                alert(thrownError);
                            }
                        }
                    });
                });
                $('#btnConect').on('click',function(){
                    console.log("conect");
                    dragndrop.setToConnect();
                });
                $('#btnSelect').on('click',function(){
                    console.log("select")
                    dragndrop.setToSelect();
                }); 
    		});
            
            function enableBtnNext(flag){
                var status=flag;
                if(flag===undefined){
                    status=true;
                }
                if(status){
                    $('#btnNext').css("background-color", "#f00");
                }
                else{
                    $('#btnNext').css("background-color", "#AAB3AB");
                }
                $('#btnNext').prop('disabled', !status);
            }

            function enableBtnExecute(flag){
                var status=flag;
                if(flag===undefined){
                    status=true;
                }
                if(status){
                    $('#btnExecutar').css("background-color", "#f00");
                }
                else{
                    $('#btnExecutar').css("background-color", "#AAB3AB");
                }
                $('#btnExecutar').prop('disabled', !status);
            }

            function enableBtnStart(flag){
                var status=flag;
                if(flag===undefined){
                    status=true;
                }
                if(status){
                    $('#btnStart').css("background-color", "#f00");
                }
                else{
                    $('#btnStart').css("background-color", "#AAB3AB");
                }
                $('#btnStart').prop('disabled', !status);
            }

            function enableBtnStop(flag){
                var status=flag;
                if(flag===undefined){
                    status=true;
                }
                if(status){
                    $('#btnStop').css("background-color", "#f00");
                }
                else{
                    $('#btnStop').css("background-color", "#AAB3AB");
                }
                $('#btnStop').prop('disabled', !status);
            }

            function clearMemory(){
                var parent=document.getElementById('memoria');
                //o cabecalho nao e apagado
                for(var i = parent.rows.length-1; i > 0;i--){
                  parent.deleteRow(i);
                }
            }

            function clearConsole(){
                $('#consola').empty();
            }

            function writeConsole(data,color){
                color=color||"#000000";
                $("#consola").append('<span style="color:'+color+'">'+data+'<br></span>');
                $("#consola").scrollTop($("#consola")[0].scrollHeight); //scroll automatico
            }

            function writeConsoleError(data){
                writeConsole(data,"#FF0011");
            }

            function writeConsoleMessage(data){
                writeConsole(data,"#000000");
            }

            function writeConsoleInfo(data){
                writeConsole(data,"#107ECC");
            }

            function fillMemory(vars){
                for(var i=0; i<vars.length; i++){
                  addRowMemory(vars[i]);
                }
            }

            function addRowMemory(variable){
                var parent=document.getElementById("memoria");
                console.log(parent.rows.length);
                var newRow = parent.insertRow(parent.rows.length);
                var name = newRow.insertCell(0);
                var type = newRow.insertCell(1);
                var value = newRow.insertCell(2);
                var level = newRow.insertCell(3);
                name.innerHTML = variable.name_;
                type.innerHTML = variable.type_;
                value.innerHTML = variable.value_;
                level.innerHTML = variable.level_;
            }
		</script>
	</head>

	<body class="cbp-spmenu-push">
        <nav class="cbp-spmenu cbp-spmenu-vertical cbp-spmenu-left" id="cbp-spmenu-s1">
            <h3>Memoria</h3>
            <table border="1" id="memoria" style="background-color:#fff; color:#000; font-size:76%;">
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Nivel</th>
                </tr>
            </table>
            <form>
                <fieldset>
                    <legend>Selecting elements</legend>
                    <p>
                        <label>Linguaguem Programação</label>
                        <select id = "myList">
                            <option value = "1">C++</option>
                            <option value = "2">C#</option>
                            <option value = "3">java</option>
                            <option value = "4">Python</option>
                        </select>
                        <label>Idioma</label>
                        <select id = "myList2">
                            <option value = "1">Portugues</option>
                            <option value = "2">Inglês</option>
                            <option value = "3">Espanhol</option>
                            <option value = "4">Russo</option>
                        </select>        
                    </p>
                </fieldset>
            </form>          
        </nav>
        <nav class="cbp-spmenu cbp-spmenu-horizontal cbp-spmenu-bottom " id="cbp-spmenu-s4">
            <h3>Consola</h3>
            <div id="consola" width="300" border="1" height="500px" style="background-color:#fff; color:#000; font-size:78.5%;">
                Consola: 

            </div>
        </nav>
        <nav class="cbp-spmenu cbp-spmenu-vertical cbp-spmenu-right cbp-spmenu-open" id="cbp-spmenu-s2">
            <h3>ToolBox</h3>
            <a id="showBottom">Tools</a> 
            <a id="btnApagar">Apagar</a>
            <a id="btnValidar">Validar</a>
            <a id="btnExecutar">Executar</a>
            <a id="btnAbrir"> Abrir</a>
            <a id="btnGuardar"> Guardar</a>
            <a id="btnConect">Conexões</a>
            <a id="btnSelect">Select</a>
            <a id="btnStart">START</a>
            <a id="btnNext">NEXT</a>
            <a id="btnStop">STOP</a>

        </nav>

        <div class="xpto" id="canvas"></div>
       
        <script>
            var menuLeft = document.getElementById( 'cbp-spmenu-s1' ),
                menuLeft2 = document.getElementById( 'cbp-spmenu-s5' ),
                menuRight = document.getElementById( 'cbp-spmenu-s2' ),
                menuTop = document.getElementById( 'cbp-spmenu-s3' ),
                menuBottom = document.getElementById( 'cbp-spmenu-s4' ),
                showLeft = document.getElementById( 'showLeft' ),
                showRight = document.getElementById( 'showRight' ),
                showTop = document.getElementById( 'showTop' ),
                showBottom = document.getElementById( 'showBottom' ),
                showLeftPush = document.getElementById( 'showLeftPush' ),
                showRightPush = document.getElementById( 'showRightPush' ),
                body = document.body;
          
            showBottom.onclick = function() {
                classie.toggle( this, 'active' );
                classie.toggle( menuLeft, 'cbp-spmenu-open' );
                classie.toggle( menuBottom, 'cbp-spmenu-open' );
            };
        </script>
    </body>
</html>